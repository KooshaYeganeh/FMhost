#!/bin/bash

APP_NAME="FMhost"
VERSION="1.0"
INSTALL_DIR="/opt/$APP_NAME"
DEB_DIR="deb_build"
DEB_PACKAGE="$APP_NAME"_"$VERSION"_all.deb

# Cleanup old build
echo "Cleaning up old build..."
rm -rf $DEB_DIR
mkdir -p $DEB_DIR/DEBIAN $DEB_DIR/$INSTALL_DIR $DEB_DIR/usr/bin

# Create control file
echo "Creating control file..."
cat <<EOF > $DEB_DIR/DEBIAN/control
Package: $APP_NAME
Version: $VERSION
Architecture: all
Maintainer: Your Name <your@email.com>
Depends: python3, python3-pip, python3-flask
Section: web
Priority: optional
Description: A Flask-based web application packaged as a .deb file
EOF

# Copy application files
echo "Copying application files..."
cp -r app install LICENSE README.md requirements.txt run $DEB_DIR/$INSTALL_DIR/

# Create executable launcher script
echo "Creating launcher script..."
echo -e "#!/bin/bash\npython3 $INSTALL_DIR/run" > $DEB_DIR/usr/bin/$APP_NAME
chmod +x $DEB_DIR/usr/bin/$APP_NAME

# Create post-installation script to install dependencies
echo "Creating post-install script..."
cat <<EOF > $DEB_DIR/DEBIAN/postinst
#!/bin/bash
pip3 install -r $INSTALL_DIR/requirements.txt
EOF
chmod +x $DEB_DIR/DEBIAN/postinst

# Build the .deb package
echo "Building .deb package..."
dpkg-deb --build $DEB_DIR $DEB_PACKAGE

echo "Package created: $DEB_PACKAGE"
echo "Install with: sudo dpkg -i $DEB_PACKAGE"

